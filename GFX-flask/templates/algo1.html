
<!DOCTYPE html>
<html lang="en">
  <head>
    {{ codemirror.include_codemirror() }}
     <link rel=stylesheet type=text/css href="{{ url_for('static', filename='css/bootstrap.css') }}">

    
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link href="http://cartodb-libs.global.ssl.fastly.net/cartodbui/assets/2.13.19/favicons/favicon.ico?1393581969" rel="shortcut icon" type="image/vnd.microsoft.icon" />
    <title>GDELT Violence | CartoDB</title>
    <meta name="description" content="GDELT Violence">
    <meta name="keywords" content="Map,cartodb,GDELT,Violence">
    <meta name="author" content="CartoDB">
    <meta name="DC.title" content=" | CartoDB">
    <meta property="og:title" content="GDELT Violence | CartoDB"/>
    <meta property="og:description" content="GDELT Violence"/>
    <meta property="og:type" content="Visualization"/>
    <meta property="og:url" content="http://npk.cartodb.com/viz/4722ead6-fdd3-11e3-a249-0edbca4b5057/embed_map?title=true&description=true&search=true&shareable=true&cartodb_logo=true&layer_selector=false&legends=true&scrollwheel=true&fullscreen=false&sublayer_options=1%7C1&zoom=2&center_lat=37.994401411046148&center_lon=29.179687499999996%27" />
    <meta property="og:image" content="http://cartodb-libs.global.ssl.fastly.net/cartodbui/assets/2.13.19/images/layout/cartofante_blue.png"/>

   <meta charset="utf-8">
        <link rel=stylesheet type=text/css href="{{ url_for('static', filename='nv.d3.css') }}">
        <script src="{{ url_for('static', filename='d3.v3.js') }}"></script>
        <script src="{{ url_for('static', filename='nv.d3.js') }}"></script>



    <style type="text/css">
      html, body, #map {height: 100%; padding: 0; margin: 0;}
      .cartodb-text {position:absolute; display:none; bottom:0; left:0; right:0; margin:0; padding:0 10px; background:white; font:normal 11px "Helvetica",Arial; color:#999999; border-top:1px solid #CCC; border-top:1px solid rgba(0,0,0,0); box-shadow:rgba(0,0,0,0.6) 0 0 1px 0; -webkit-box-shadow:rgba(0,0,0,0.6) 0 0 1px 0; -moz-box-shadow:rgba(0,0,0,0.6) 0 0 1px 0; -o-box-shadow:rgba(0,0,0,0.6) 0 0 1px 0; line-height:29px; z-index:2; }
      .cartodb-text a {color:#397DB8; text-decoration:underline;}

      #not_supported_dialog {position:absolute; width:356px; height:213px; top:50%; left:50%; margin-top:-107px; margin-left:-178px; padding:0; background-color:#FFF; text-align:center; font-family:'Helvetica', Arial; color:#666666; z-index:10000;}
      #not_supported_dialog h2 {display:inline-block; width:77px; margin:30px 0 0; padding-bottom:16px; font-size:13px; font-weight:bold; border-bottom:1px solid #D9D9D9; vertical-align:top; zoom:1; *display:inline;}
      #not_supported_dialog p {display:block; padding:0 40px; margin:12px 0 0; font-size:15px;}
      #not_supported_dialog ul {position:absolute; bottom:0; left:0; right:0; display:block; margin:0; padding:0; list-style:none; border-top:1px solid #D9D9D9;}
      #not_supported_dialog ul li {float:left; margin:0; padding:0; border-right:1px solid #D9D9D9;}
      #not_supported_dialog ul li a {display:block; width:118px; height:74px; background-repeat:no-repeat; background-position:center center; font-size:0; line-height:0; text-indent:-9999px;}
      #not_supported_dialog ul li.last {border:none;}
      #not_supported_dialog a.safari {background-image:url('//cartodb-libs.global.ssl.fastly.net/cartodbui/assets/2.13.19/images/layout/safari.png');}
      #not_supported_dialog a.chrome {background-image:url('//cartodb-libs.global.ssl.fastly.net/cartodbui/assets/2.13.19/images/layout/chrome.png');}
      #not_supported_dialog a.firefox {background-image:url('//cartodb-libs.global.ssl.fastly.net/cartodbui/assets/2.13.19/images/layout/firefox.png');}

      /* Styles showing up new cartodb text */
        .cartodb-map-wrapper {bottom:30px!important;}
        .cartodb-text {display:block;}

    </style>

        <link rel="stylesheet" href="http://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/themes/css/cartodb.css" />

      <script type="text/javascript" src="http://dl1d2m8ri9v3j.cloudfront.net/releases/1.2.2/tracker.js" data-customer="cf7a7cd8411140689ea94e92d9fba842"></script>
      <script type="text/javascript" src="http://cartodb-libs.global.ssl.fastly.net/cartodbui/assets/2.13.19/javascripts/statsc.js?_=1404626491361"></script>
      <script src="http://cartodb-libs.global.ssl.fastly.net/cartodbui/assets/2.13.19/javascripts/statsc.js?_=1404626095655"></script>
  </head>
  <body>
      <h1 style="text-align:center;">Python Algorithmic Backtester</h1>
    <form action ="{{ url_for('algoe')  }}" method = "POST">
      {{ form.source_code }}
      <br><button type="submit" class="btn btn-primary">
         <i class="icon-user icon-cobalt"></i> Execute Backtest
         </button>
      
      <br>
      <br>
      
      {% if run == True %}
      <div id="map" style="width: 1300px; height: 400px" ></div>

      <br>
      <br>

      
      <svg style='height:350px; width: 1300px'/>

      {% endif %}

      <div id="not_supported_dialog" style="display: none">
        <h2>CartoDB</h2>
        <p>This visualization only works in modern browsers. Upgrade yours and enjoy.</p>
        <ul>
          <li><a href="http://www.apple.com/safari/" class="safari">Safari</a></li>
          <li><a href="https://www.google.com/chrome/" class="chrome">Chrome</a></li>
          <li class="last"><a href="http://www.mozilla.org/en-US/firefox/all/â€Ž" class="firefox">Firefox</a></li>
        </ul>
      </div>
      

      <!-- if you are using google maps, uncomment the following line -->
      <!-- <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script> -->

      <script src="http://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/cartodb.js"></script>
      <script src="http://cartodb-libs.global.ssl.fastly.net/cartodbui/assets/2.13.19/javascripts/statsc.js?_=1404626095655"></script>
    <script>
      
      var gds = JSON.parse({{gds |tojson}});
      console.log(gds);

      function get_url_params(conversion) {

        conversion = conversion || {};

        var tokens = location.search.slice(1).split('&');
        var params = {};

        for (var i = 0; i < tokens.length; ++i) {

          var tk = tokens[i].split('=');
          var fn = conversion[tk[0]] || function(v) { return v };

          if (tk.length === 2) {
            params[tk[0]] = fn(decodeURIComponent(tk[1]));
          }
        }

        return params;
      }

      function manageError(err, layer) {
          if(layer && layer.get('type') === 'torque') {
              $('#not_supported_dialog').show();
              // hide all the overlays
              var overlays = this.getOverlays()
              for (var i = 0; i < overlays.length; ++i) {
                  var o = overlays[i];
                  o.hide && o.hide();
              }
          }
      }

      function stats() {
          var browser;
          var ua = navigator.userAgent;
          var checks = [
              ['MSIE 10.0', 'ms10'],
              ['MSIE 9.0', 'ms9'],
              ['MSIE 8.0', 'ms8'],
              ['MSIE 7.0','ms7'],
              ['Chrome', 'chr'],
              ['Firefox', 'ff'],
              ['Safari', 'ff']
          ]
          for(var i = 0; i < checks.length && !browser; ++i) {
            if(ua.indexOf(checks[i][0]) !== -1) browser = checks[i][1];
          }
          browser = browser || 'none';
          cartodb.core.Profiler.metric('cartodb-js.embed.' + browser).inc();
      }

      $(document).ready(function(){

        var bool_fn = function(v) { return v == 'true' }
        , is_custom_install = false
        , logo_fn  = function(v) { return ( true || is_custom_install ) ? true : v == 'true' }
        , layer_fn = function(v) {
          if(!v || !v.length) {
              return null;
          }

          return _.map(v.split("|"), function(v) {
            return { visible: !!parseInt(v, 10) }
          });

        };

        var opt = get_url_params({
          'search':       bool_fn,
          'title':        bool_fn,
          'description':  bool_fn,
          'shareable':    bool_fn,
          'fullscreen':   bool_fn,
          'cartodb_logo': logo_fn,
          'scrollwheel':  bool_fn,
          'sublayer_options': layer_fn,
          'layer_selector': bool_fn,
          'legends': bool_fn
        });

        opt.search = true;


        cartodb.config.set({
          cartodb_attributions: "CartoDB <a href='http://cartodb.com/attributions?utm_source=Footer_Link&utm_medium=referral&utm_campaign=Embed_v1&utm_content=Attributions&utm_term=npk' target='_blank'>attribution</a>",
          cartodb_logo_link: "http://www.cartodb.com?utm_source=Footer_Link&utm_medium=referral&utm_campaign=Embed_v1&utm_content=Logo"
        })

        var loadingTime = cartodb.core.Profiler.metric('cartodb-js.embed.time_full_loaded').start();
        var visReadyTime = cartodb.core.Profiler.metric('cartodb-js.embed.time_vis_loaded').start();

        cartodb.createVis('map', {"id":"4722ead6-fdd3-11e3-a249-0edbca4b5057","version":"0.1.0","title":"GDELT_Violence","description":null,"url":null,"map_provider":"leaflet","bounds":[[-6.839169626342808,-90.87890625],[54.57206165565852,149.23828125]],"center":"[-38.07198030177986, 29.179687499999996]","zoom":2,"updated_at":"2014-06-27T08:43:06+00:00","layers":[{"options":{"visible":true,"type":"Tiled","urlTemplate":"https://{s}.maps.nlp.nokia.com/maptile/2.1/maptile/newest/normal.day/{z}/{x}/{y}/256/png8?lg=eng&token=A7tBPacePg9Mj_zghvKt9Q&app_id=KuYppsdXZznpffJsKT24","subdomains":"1234","name":"Nokia Day","className":"httpssmapsnlpnokiacommaptile21maptilenewestnormaldayzxy256png8lgengtokena7tbpacepg9mj_zghvkt9qapp_idkuyppsdxzznpffjskt24","attribution":"\u00a92012 Nokia <a href='http://here.net/services/terms' target='_blank'>Terms of use</a>","id":"2a53f537-f9b2-4d95-85b0-4e8c641f8b3f","order":0},"infowindow":null,"tooltip":null,"id":"2a53f537-f9b2-4d95-85b0-4e8c641f8b3f","order":0,"type":"tiled"},{"type":"layergroup","options":{"user_name":"npk","tiler_protocol":"http","tiler_domain":"cartodb.com","tiler_port":"80","sql_api_protocol":"http","sql_api_domain":"cartodb.com","sql_api_endpoint":"/api/v2/sql","sql_api_port":80,"cdn_url":{"http":"api.cartocdn.com","https":"cartocdn.global.ssl.fastly.net"},"layer_definition":{"stat_tag":"4722ead6-fdd3-11e3-a249-0edbca4b5057","version":"1.0.1","layers":[{"id":"4c1dab56-a214-4e90-8e22-cf5d2f47f271","type":"CartoDB","infowindow":{"fields":[{"name":"field_8","title":true,"position":6}],"template_name":"table/views/infowindow_light","template":"<div class=\"cartodb-popup v2\">\n  <a href=\"#close\" class=\"cartodb-popup-close-button close\">x</a>\n  <div class=\"cartodb-popup-content-wrapper\">\n   <div class=\"cartodb-popup-tip-container\"></div>\n</div>\n","alternative_names":{},"width":226,"maxHeight":180},"tooltip":null,"legend":{"type":"intensity","show_title":false,"title":"","template":"","items":[{"name":"Left label","visible":true,"value":"Less","legend_type":"intensity","type":"text","sync":true},{"name":"Right label","visible":true,"value":"More","legend_type":"intensity","type":"text","sync":true},{"name":"Color","visible":true,"value":"#FFCC00","type":"color"}]},"order":1,"options":{"sql": gds,"layer_name":"gdv911","cartocss":"/** intensity visualization */\n\n\n#gdv911{\n  marker-fill: #FFCC00; \n  marker-width: 10; \n  marker-line-color: #FFF; \n  marker-line-width: 1.5; \n  marker-line-opacity: 1; \n  marker-fill-opacity: 0.9; \n  marker-comp-op: multiply; \n  marker-type: ellipse; \n  marker-placement: point; \n  marker-allow-overlap: true; \n  marker-clip: false; \n  marker-multi-policy: largest; \n}","cartocss_version":"2.1.1","interactivity":"cartodb_id"}}]}}},{"id":"37bf9221-f4d2-4ec0-a539-6ad6db75045f","type":"torque","order":102,"legend":{"type":"none","show_title":false,"title":"","template":"","items":[{"name":"Left label","visible":true,"value":"Less","legend_type":"intensity","type":"text","sync":true},{"name":"Right label","visible":true,"value":"More","legend_type":"intensity","type":"text","sync":true},{"name":"Color","visible":true,"value":"#FFCC00","type":"color"}]},"options":{"stat_tag":"4722ead6-fdd3-11e3-a249-0edbca4b5057","tiler_protocol":"http","tiler_domain":"cartodb.com","tiler_port":"80","sql_api_protocol":"http","sql_api_domain":"cartodb.com","sql_api_endpoint":"/api/v2/sql","sql_api_port":80,"cdn_url":{"http":"api.cartocdn.com","https":"cartocdn.global.ssl.fastly.net"},"layer_name":"gdv911","query":"select * from gdv911 where sqldate > '2003-09-01' and field_8 = 'IZ' limit 100","table_name":"gdv911","user_name":"npk","tile_style":"/** torque visualization */\n\nMap {\n-torque-frame-count:512;\n-torque-animation-duration:120;\n-torque-time-attribute:\"sqldate\";\n-torque-aggregation-function:\"count(cartodb_id)\";\n-torque-resolution:2;\n-torque-data-aggregation:linear;\n}\n\n#gdv911{\n  comp-op: lighter;\n  marker-fill-opacity: 0.9;\n  marker-line-color: #000000;\n  marker-line-width: 6;\n  marker-line-opacity: 1;\n  marker-type: ellipse;\n  marker-width: 6;\n  marker-fill: #FF9900;\n}\n#gdv911[frame-offset=1] {\n marker-width:8;\n marker-fill-opacity:0.45; \n}\n#gdv911[frame-offset=2] {\n marker-width:10;\n marker-fill-opacity:0.225; \n}"}}],"overlays":[{"type":"zoom","order":null,"options":null,"template":"<a class=\"zoom_in\">+</a><a class=\"zoom_out\">-</a>"},{"type":"loader","order":null,"options":null,"template":"<div class=\"loader\"></div>"}]}, opt, function(vis) {
          visReadyTime.end();
          vis.on('load', function() {
            loadingTime.end();
          })
          // add here your code
          window.vis = vis;
          map = vis.getNativeMap();
          map.setZoom(2);
          map.panTo(new L.LatLng(40.737, -73.923));
          // some stats
          stats();
        }).on('error', manageError);
      });
      //<!-- load stats -->
        if (location.protocol.indexOf('https') === -1) {
          jQuery.getScript('//cartodb-libs.global.ssl.fastly.net/cartodbui/assets/2.13.19/javascripts/statsc.js', function(ready) {
            statsc.connect('http://s.cartodb.net:8127/');
            cartodb.core.Profiler.backend(function () {
              statsc.send.apply(statsc, arguments);
            })
            // stop sending stats after 11 seconds
            // statsc send stats in 5 secs interval so allow to send at least twice
            setTimeout(function() {
                cartodb.core.Profiler.backend(null);
            }, 11*1000);
          })
        }

    </script>
        <script type="text/javascript">
      var _gaq = _gaq || []; 
      _gaq.push(['_setAccount', 'UA-20934186-10']);
      _gaq.push(['_setDomainName', 'cartodb.com']);
      _gaq.push(['_setAllowLinker', true]);
      _gaq.push(['_trackPageview']);

      (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })();
    </script>


    <script>
	function myStuff() {

	var ms = [];
	console.log({{var|tojson}}.length);
	//console.log({{var|tojson}});
	var vjson = JSON.parse({{var|tojson}})
	console.log(vjson);
	ms = []
	for (var c = 0; c < vjson.length; c++) {

	    //var d = vjson[c][0].toString();
	    //var year = d.substring(0,4);
	    //var month = d.substring(4,6);
            //var day = d.substring(6,8)
            var da = new Date(vjson[c][0]);
	    ms.push({x: da, y: vjson[c][6]});

	}

	var stuff = [ {x: 1, y: 3}, {x:2, y:5 }, {x: 3, y: 7} ];
//stuff = 33;
console.log(ms)
console.log(stuff);

return [
        {
            key: "{{pair}}",
            values: ms,
            color: "#0000ff"
        }
    ];
	
}
    
	function myData() {
    var series1 = [];
    for(var i =1; i < 100; i ++) {
        series1.push({
            x: i, y: 100 / i
        });
    }
    
    console.log(series1);
    console.log(myStuff());
    return [
        {
            key: "Series #1",
            values: series1,
            color: "#0000ff"
        }
    ];
}

nv.addGraph(function() {
    var chart = nv.models.lineChart();

    chart.forceY([-500,500]);

    chart.xAxis
        .axisLabel("Time")
	.tickFormat(function(d) { return d3.time.format('%m %d %Y')(new Date(d)); })
	;

    chart.yAxis
        .axisLabel("Backtesting P&L")
        .tickFormat(d3.format("d"))
        ;

    chart.margin({left: 80, right: 50});

    d3.select("svg")
        .datum(myStuff())
        .transition().duration(500).call(chart);

    nv.utils.windowResize(
            function() {
                chart.update();
            }
        );

    return chart;
});





	</script>

  </body>
</html>

